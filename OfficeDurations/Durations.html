<!DOCTYPE html>
<html lang="tr-TR"><!-- ?? tr-TR ?? -->
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Date sorting</title>
    <link rel="stylesheet" href="css/style.css">
    
<!--
Türkiye Cumhuriyeti kurulmasından itibaren, devlet yönetiminde olan kişilerin, görevleri ve görevde bulundukları sürelerin zamana çizelgesinde gösterilmesi. 
    - Görev filtresi.
    - Sıralama seçenekleri. Alfabetik, yıla göre
    - Gösterim detay filtresi.
    - Kişi adı arama. Yazdıkça alternatiflerin gelmesi...(opsiyonel.)
Görsel Özellikler
    - üst tarafta sabit menü üzerinde filtre ve sıralama seçenekleri
    - üst tarafta sabit menünün hemen altında yine sabit olacak şekilde yıl kılavuzları. 10 yıllık aralıklar ile
    - her bir kişinin yanında toplam görev süresini gösteren zaman çizelgesi ve toplam gün sayısı
    - her bir kişinin altında yıllara göre görevleri ve zaman çizelgesi gösterimi
-->
</head>
<body>
<div class="container">
    <div id="header">
        <form id="preferences" name="preferences">
        <span>
            <fieldset>
                <legend>Gruplama</legend>
                <input name="group" type="radio" onclick="reload()" value ="k" Checked> Kişi
                <input name="group" type="radio" onclick="reload()" value ="g"> Görev
                <input name="group" type="radio" onclick="reload()" value ="y" disabled> Yıl
            </fieldset>
        </span>
        
        <span>
            <fieldset disabled>
                <legend>Filtre</legend>
                <input name="filtre" value="c" id="c" type="checkbox" onclick="loadKisiList()" checked>Cumhurbaşkanı
                <input name="filtre" value="b" id="b" type="checkbox" onclick="loadKisiList()" checked>Başbakan
                <input name="filtre" value="d" id="d" type="checkbox" onclick="loadKisiList()" checked>Bakanlar
            </fieldset>
           
        </span>
        
        <span >
            <fieldset>
               <legend>Sıralama</legend>
                <input name="sira" type="radio" onclick="reload()" value="t" checked>Tarihe Göre
                <input name="sira" type="radio" onclick="reload()" value="a" >Alfabetik
                <input name="sira" type="radio" onclick="reload()" value="g" disabled>Görev Süresi
            </fieldset>
        </span>
        
       
        <span >
            <fieldset>
                <legend>Gösterim</legend>
                <input name="detay" type="radio" onclick="reload()" value="a" id="a">Sadece Başlık
                <input name="detay" type="radio" onclick="reload()" checked>Hepsini Göster
            </fieldset>
        </span>
        </form>
        <br><br>
        <div>
            <span style="width: 105em">
<!--                <span style="width: 200px;height: 1px;display: inline-block;">_</span>-->
                <span class="gorevline hyear" style="left: 20em; width: 0.0666667em;">1920</span>
                <span class="gorevline hyear" style="left: 28em; width: 0.0666667em;">1930</span>
                <span class="gorevline hyear" style="left: 36em; width: 0.0666667em;">1940</span>
                <span class="gorevline hyear" style="left: 44em; width: 0.0666667em;">1950</span>
                <span class="gorevline hyear" style="left: 52em; width: 0.0666667em;">1960</span>
                <span class="gorevline hyear" style="left: 60em; width: 0.0666667em;">1970</span>
                <span class="gorevline hyear" style="left: 68em; width: 0.0666667em;">1980</span>
                <span class="gorevline hyear" style="left: 76em; width: 0.0666667em;">1990</span>
                <span class="gorevline hyear" style="left: 84em; width: 0.0666667em;">2000</span>
                <span class="gorevline hyear" style="left: 92em; width: 0.0666667em;">2010</span>
                <span class="gorevline hyear" style="left: 100em; width: 0.0666667em;">2020</span>
            </span>
        </div>
    </div>
   
      
    
<p id="demo"></p>    
</div>


</body>
 

<script>
 
    /*
    
    TODO Notes:
    ----
    - format header nicely
    - sticky header and year guides
    - kisi collapse triangle (+/-)  and cursor
    - viewport sizable timeline
    - format nicely
    - year guides, timelines etc consistency. please not just put there
    - add - milletvekilleri, bakanlar,belediye başkanları
    
    ++++
    + gorev dates in a more readable form
    + kisi collapsable. 
    + kisi (one timeline to show next to it would be blast)
    + timeline next to gorev definition
    + better calculation for timeline width 
    + number of days on the office to the right side of the kisi. 
    + filter for different gorevs
    + collapse all
    + right calculation for the repeated days. !!
    + fill out all kisiler...
    
    */
    var veri=[];
    var kisi_list = [];
    var gorev_list = [];
    //var t = "";
    loadData();
    
    
function transformToGorev(){
     gorev_list = veri.reduce(function(groups,kisi){
        for (var gorev of kisi.Gorevler){
            var mygroup = groups.find(function(elm){return elm["SubHeaderText"] == gorev.Tanimi})
            if(!mygroup){
                groups.push({"SubHeaderText":gorev.Tanimi,"Items":[]})
                mygroup = groups[groups.length-1];
            }
            mygroup["Items"].push({"Ad": kisi.Ad,"BaslangicTarihi":new Date(gorev.Baslangic),"BitisTarihi":new Date(gorev.Bitis)});
        }
        return groups;
        
    },[{"SubHeaderText":veri[0].Gorevler[0].Tanimi,"Items":[]}]);
    
}
    
function transformToKisi(){
    if (veri=="") return;
    kisi_list = veri.map(function(kisi){
        var newobj = {"SubHeaderText": kisi.Ad + "("+kisi.Dogum + "-" + kisi.Olum + ") ","Items":[] };

        for (var gorev of kisi.Gorevler){
            gorev.BaslangicTarihi = new Date(gorev.Baslangic);
            gorev.BitisTarihi = new Date(gorev.Bitis);
            newobj.Items.push({"Ad": gorev.Tanimi,"BaslangicTarihi":gorev.BaslangicTarihi,"BitisTarihi":gorev.BitisTarihi});
        }
        //kisi.Gorevler.sort(sortGorevler);
        //kisi.ilktarih=kisi.Gorevler[0].BaslangicTarihi;
        newobj.Items.sort(function(a,b){return a.BaslangicTarihi-b.BaslangicTarihi;});
        return newobj;
    })
    
}

 
function paintTimelineNew(elem,bas,bit,txt){
    var beginning = new Date("1920-01-01");
    var eGorevLine =document.createElement("span");
    eGorevLine.classList.add("gorevline");
   
    eGorevLine.style.left=(dateDiffToWidth(beginning,bas) + 20.7).toString() + "em";
    eGorevLine.style.width=dateDiffToWidth(bas,bit).toString() + "em";
    eGorevLine.textContent=txt;
    elem.appendChild(eGorevLine);
}
function dateDiffToWidth(bas,bit){
    var px =(((bit.getFullYear()-bas.getFullYear()) * 12) - bas.getMonth()+ bit.getMonth()) ;
    return  px/15 ;
}
function myclick(e){ // kisi başlığına tıklama için
    //TODO: more elegant way !!
    this.children[1].hidden= !(this.children[1].hidden);
    this.children[3].hidden= !(this.children[3].hidden);
    //this.lastElementChild.hidden=!(this.lastElementChild.hidden);
}
 
function sortGorevler(a,b){
        return a.BaslangicTarihi - b.BaslangicTarihi;
}
   
function loadData() { // Verileri yüklemek için AJAX request
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
    initData(this);
    }
  };
  xhttp.open("GET", "data/data.json", true);
  xhttp.send();
}

function initData(xml) { // Verilerin düştüğü yer
    veri =JSON.parse( xml.responseText);
    reload();
}

function reload(){
    if(veri=="")return;
    
    var group = document.preferences.group.value;
    var sortOrder = document.preferences.sira.value;
    var filters = document.preferences.filtre.values;
    var detay = document.preferences.detay.value;
    
    if(group == "k"){ //kişi bazlı gruplama
        if (kisi_list=="")
            transformToKisi(); // kişi listesini hazırla
        switch(sortOrder){
            case ("t"):
                // kişi listesi ilk göreve gelme zamanına göre sıralanır
            kisi_list.sort(function(a,b){return a.Items[0].BaslangicTarihi - b.Items[0].BaslangicTarihi;});
                break;
            case ("a"):
            // kişi listesi alfabetik sıralanır
            kisi_list.sort(function(a,b){
                var x = a.SubHeaderText.toLocaleLowerCase();
                var y = b.SubHeaderText.toLocaleLowerCase();
                if (x<y){return -1;}
                if (x>y){return 1;}
                return 0;
                });
                break;
        }
        loadList(kisi_list,filters,detay);
    }
    if(group=="g"){ // gorev bazlı gruplama
        if (gorev_list =="") 
            transformToGorev();// görev listesini hazırla
        switch (sortOrder){
            case "t":
                // gorev grubu altındaki kişilerin başlangıç tarihi
                for(items of gorev_list)
                    items.Items.sort(function(a,b){return a.BaslangicTarihi-b.BaslangicTarihi;});
                gorev_list.sort(function(a,b){
                    //TODO: aynı tarihse alfabetik ?
                    a.Items[0].BaslangicTarihi-b.Items.BaslangicTarihi;
                    });
                break;
            case "a":
                // gorev grubu altındakilerin isimlerinin alfabetik sıralaması
                for(items of gorev_list)
                    items.Items.sort(function(a,b){
                        var x = a.Ad.toLocaleLowerCase();
                        var y = b.Ad.toLocaleLowerCase();
                        if (x<y){return -1;}
                        if (x>y){return 1;}
                        return 0;
                    });
                
                gorev_list.sort(function(a,b){
                        var x = a.SubHeaderText.toLocaleLowerCase();
                        var y = b.SubHeaderText.toLocaleLowerCase();
                        if (x<y){return -1;}
                        if (x>y){return 1;}
                        return 0;
                    });
                break;
        }
        
    loadList(gorev_list,filters,detay);
    }
 
} 

 
    

function loadList(list,filters,detay){
 if (list =="") return;
 
  var eSubHeaderList = document.createElement("ul"); 
   
  for (i=0;i< list.length;i++){
      var subHeader =list[i];
      //var kisiArticle = document.createElement("ul");
      var eSubHeader = document.createElement("li");
      eSubHeader.classList.add("subHeader");
      eSubHeader.addEventListener("click",myclick);
      
      var eSubHeaderText = document.createElement("span");
      //"&#x25BC;"  aşağı üçgen  //&#x25B6; sağa bakan  //&#x25C0; sola bakan
      eSubHeaderText.textContent=  subHeader.SubHeaderText; // For testing purposes + kisi.ilktarih.toLocaleDateString();     //****
      eSubHeaderText.classList.add("kisiadi");
      eSubHeader.appendChild(eSubHeaderText);
      
      var eSubHeaderTimeLine = document.createElement("span");
      eSubHeaderTimeLine.hidden=true;
      
      var eItemList = document.createElement("ul");
      eItemList.className="itemlist";
      
      var toplamGun = 0;

      for(var k = 0; k<subHeader.Items.length;k++){
          var item = subHeader.Items[k];
          //if((item.Kodu=="C" && c) || (item.Kodu=="BB" &&b) || (item.Kodu == "B" && d)){
              var eItem=document.createElement("li");
              var eItemSpan = document.createElement("span");
              eItemSpan.classList.add("item");

              toplamGun+= Math.round((item.BitisTarihi-item.BaslangicTarihi)/86400000 );


              eItemSpan.textContent =  item.Ad + " (" +
                        item.BaslangicTarihi.toLocaleDateString() + "-" + item.BitisTarihi.toLocaleDateString() + ")";
              eItem.appendChild(eItemSpan);


              paintTimelineNew(eItem,item.BaslangicTarihi,item.BitisTarihi );
              paintTimelineNew(eSubHeaderTimeLine,item.BaslangicTarihi,item.BitisTarihi);

              eItemList.appendChild(eItem);
          //}
      }
      
      eSubHeader.appendChild(eSubHeaderTimeLine);
      var eToplamGun = document.createElement("span");
      eToplamGun.textContent=toplamGun.toLocaleString();
      eToplamGun.style.float="right";
      eSubHeader.appendChild(eToplamGun);
    
    
    eSubHeader.appendChild(eItemList);
      
    if(eItemList.childElementCount>0){
        eSubHeaderList.appendChild(eSubHeader);
      }
      if (detay == "a")
        eSubHeader.click();
  }
    if (document.getElementById("demo").childElementCount>0)
        document.getElementById("demo").removeChild(document.getElementById("demo").children[0]);
    document.getElementById("demo").appendChild(eSubHeaderList); 
}
    
   
    </script>
</html>